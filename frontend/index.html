<!DOCTYPE html>
<html>
<head>
    <title>EquityBridge</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <script src="https://js.arcgis.com/4.28/"></script>
    <style>
        body { font-family: Arial; margin: 0; padding: 0; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; text-align: center; }
        .header h1 { margin: 0; }
        .tabs { background: white; display: flex; border-bottom: 2px solid #ddd; max-width: 1200px; margin: 0 auto; }
        .tab { padding: 15px 30px; cursor: pointer; border: none; background: none; font-size: 16px; color: #666; }
        .tab.active { color: #667eea; border-bottom: 3px solid #667eea; font-weight: 600; }
        .tab:hover { background: #f5f5f5; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background: white; border-radius: 10px; display: none; }
        .container.active { display: block; }
        input, select, textarea { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        button { background: #667eea; color: white; padding: 15px; width: 100%; border: none; font-size: 18px; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        button:hover { background: #5568d3; }
        .results-container { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        #mapDiv { height: 500px; border-radius: 8px; border: 2px solid #e0e7ff; }
        .grant { background: #f8f9ff; padding: 20px; margin: 15px 0; border-radius: 8px; border-left: 4px solid #4ade80; }
        .grant h3 { margin-top: 0; }
        .score { background: #4ade80; color: white; padding: 5px 10px; border-radius: 5px; display: inline-block; }
        .legend { background: #f0f0f0; padding: 15px; border-radius: 5px; margin-bottom: 10px; font-size: 14px; }
        .legend-item { margin: 5px 0; }
        .green-dot { display: inline-block; width: 12px; height: 12px; background: #4ade80; border-radius: 50%; margin-right: 5px; }
        .gray-dot { display: inline-block; width: 12px; height: 12px; background: #ccc; border-radius: 50%; margin-right: 5px; }
        .chat-container { max-width: 600px; margin: 0 auto; }
        .chat-messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px; margin-bottom: 20px; background: #fafafa; }
        .chat-message { margin: 10px 0; padding: 12px; border-radius: 8px; }
        .chat-message.bot { background: #667eea; color: white; margin-right: 50px; }
        .chat-message.user { background: #e0e7ff; color: #333; margin-left: 50px; text-align: right; }
        .chat-input-area { display: flex; gap: 10px; }
        .chat-input-area input { flex: 1; margin: 0; }
        .chat-input-area button { width: auto; margin: 0; padding: 10px 20px; }
        @media (max-width: 768px) {
            .results-container { grid-template-columns: 1fr; }
            .tabs { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üåâ EquityBridge</h1>
        <p>AI-Powered Grant Discovery for LA County Organizations</p>
    </div>

    <div class="tabs">
        <button class="tab" onclick="showTab('form')">üìù Grant Finder (Form)</button>
        <button class="tab active" onclick="showTab('chat')">üí¨ AI Chat Assistant</button>
    </div>

    <!-- FORM TAB -->
    <div id="form" class="container active">
        <h2>Find Matching Grants</h2>
        <p>Fill out the form below to find grants that match your organization's profile.</p>
        <form id="grantForm">
            <input id="name" placeholder="Organization Name" required>
            <input id="zip" placeholder="Zip Code (e.g., 92501)" required>
            <textarea id="mission" placeholder="Mission Statement" rows="3" required></textarea>
            <select id="focus" required>
                <option value="">Select Focus Area</option>
                <option value="health">Health</option>
                <option value="environment">Environment</option>
                <option value="both">Both</option>
            </select>
            <input id="budget" type="number" placeholder="Annual Budget (e.g., 500000)" required>
            <select id="staff" required>
                <option value="">Staff Size</option>
                <option value="1-5">1-5</option>
                <option value="6-20">6-20</option>
                <option value="21-50">21-50</option>
                <option value="50+">50+</option>
            </select>
            <button type="submit">Find Matching Grants</button>
        </form>
        <div id="formResults"></div>
    </div>

    <!-- CHAT TAB -->
    <div id="chat" class="container">
        <div class="chat-container">
            <h2>AI Grant Advisor</h2>
            <p>Chat with our AI to find grants. Just tell us about your organization!</p>
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message bot">
                    Hi! I'm EquityBridge, your grant advisor. What's your organization's name?
                </div>
            </div>
            <div class="chat-input-area">
                <input id="chatInput" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
        <div id="chatResults"></div>
    </div>

    <script>
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.container').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Chat state
        let chatStep = 0;
        let chatData = {};

        function addMessage(text, isUser = false) {
            const div = document.createElement('div');
            div.className = 'chat-message ' + (isUser ? 'user' : 'bot');
            div.textContent = text;
            document.getElementById('chatMessages').appendChild(div);
            document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            addMessage(msg, true);
            input.value = '';

            setTimeout(() => {
                handleChatFlow(msg);
            }, 500);
        }

        function handleChatFlow(msg) {
            chatStep++;
            
            if (chatStep === 1) {
                chatData.name = msg;
                addMessage("Great! What's your zip code?");
            } else if (chatStep === 2) {
                chatData.zip_code = msg;
                addMessage("Tell me about your organization's mission. What kind of work do you do?");
            } else if (chatStep === 3) {
                chatData.mission = msg;
                addMessage("What's your main focus area? (health, environment, or both)");
            } else if (chatStep === 4) {
                chatData.focus_area = msg.toLowerCase();
                addMessage("What's your approximate annual budget?");
            } else if (chatStep === 5) {
                chatData.annual_budget = parseInt(msg.replace(/[^0-9]/g, ''));
                addMessage("How many staff members do you have? (1-5, 6-20, 21-50, or 50+)");
            } else if (chatStep === 6) {
                chatData.staff_size = msg;
                addMessage("Perfect! Let me find matching grants for you...");
                findGrantsFromChat();
            }
        }

        async function findGrantsFromChat() {
            try {
                const res = await fetch('https://ideal-flow-production-2795.up.railway.app/api/match-grants', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(chatData)
                });

                if (!res.ok) throw new Error('API error');

                const data = await res.json();
                const grants = data.grants || [];

                addMessage(`üéØ I found ${grants.length} matching grants for ${chatData.name}!`);
                
                displayChatResults(grants, chatData);
                
            } catch(err) {
                addMessage("Sorry, I encountered an error. Please try the form instead.");
            }
        }

        function displayChatResults(grants, profileData) {
            const matchedTitles = grants.map(g => g.title);
            let html = '<div class="results-container" style="margin-top: 30px;">';
            
            html += '<div>';
            html += '<h2 style="color:#667eea;">LA County Grant Map</h2>';
            html += '<div class="legend">';
            html += '<div class="legend-item"><span class="green-dot"></span><strong>Your Matches</strong></div>';
            html += '<div class="legend-item"><span class="gray-dot"></span>Other Grants</div>';
            html += '</div>';
            html += '<div id="chatMapDiv" style="height:500px; border-radius:8px; border:2px solid #e0e7ff;"></div></div>';
            
            html += '<div class="grants-list"><h2 style="color:#667eea;">Your Matching Grants</h2>';
            grants.forEach(g => {
                html += `
                    <div class="grant">
                        <h3>${g.title}</h3>
                        <p><strong>Funder:</strong> ${g.funder}</p>
                        <p><strong>Amount:</strong> ${g.amount}</p>
                        <p><span class="score">${g.match_score}% Match</span></p>
                        <p><em>${g.match_reason}</em></p>
                        <p style="font-size:14px; color:#666;">üìç ${g.eligibility}</p>
                    </div>
                `;
            });
            html += '</div></div>';
            
            document.getElementById('chatResults').innerHTML = html;
            
            initializeMap('chatMapDiv', matchedTitles);
        }

        // Form submission
        require([
            "esri/Map",
            "esri/views/MapView",
            "esri/layers/FeatureLayer",
            "esri/Graphic",
            "esri/layers/GraphicsLayer"
        ], function(Map, MapView, FeatureLayer, Graphic, GraphicsLayer) {
            
            window.initializeMap = function(containerId, matchedTitles) {
                setTimeout(() => {
                    const map = new Map({ basemap: "gray-vector" });
                    const view = new MapView({
                        container: containerId,
                        map: map,
                        center: [-118.2437, 34.0522],
                        zoom: 9
                    });
                    
                    const grantsLayer = new FeatureLayer({
                        url: "https://services.arcgis.com/hVnyNvwbpFFPDV5j/arcgis/rest/services/LA_County_Grant_Funding_Distribution/FeatureServer/0",
                        outFields: ["*"],
                        renderer: {
                            type: "simple",
                            symbol: {
                                type: "simple-marker",
                                size: 10,
                                color: [200, 200, 200, 0.8],
                                outline: { width: 1, color: [100, 100, 100] }
                            }
                        },
                        popupTemplate: {
                            title: "{Name}",
                            content: "<b>Funder:</b> {Funder}<br><b>Amount:</b> ${Amount}<br><b>Focus:</b> {Focus}"
                        }
                    });
                    
                    map.add(grantsLayer);
                    
                    grantsLayer.when(() => {
                        const query = grantsLayer.createQuery();
                        query.where = "1=1";
                        query.outFields = ["*"];
                        query.returnGeometry = true;
                        
                        grantsLayer.queryFeatures(query).then((result) => {
                            const highlightLayer = new GraphicsLayer();
                            map.add(highlightLayer);
                            
                            result.features.forEach(feature => {
                                const grantName = feature.attributes.Name;
                                if (matchedTitles.some(title => grantName && grantName.includes(title.substring(0, 20)))) {
                                    const highlightGraphic = new Graphic({
                                        geometry: feature.geometry,
                                        symbol: {
                                            type: "simple-marker",
                                            size: 14,
                                            color: [74, 222, 128, 1],
                                            outline: { width: 2, color: [255, 255, 255] }
                                        },
                                        attributes: feature.attributes,
                                        popupTemplate: {
                                            title: "‚úÖ {Name}",
                                            content: "<b>YOUR MATCH!</b><br><b>Funder:</b> {Funder}<br><b>Amount:</b> ${Amount}<br><b>Focus:</b> {Focus}"
                                        }
                                    });
                                    highlightLayer.add(highlightGraphic);
                                }
                            });
                        });
                    });
                }, 100);
            };

            document.getElementById('grantForm').onsubmit = async (e) => {
                e.preventDefault();
                const out = document.getElementById('formResults');
                out.innerHTML = '<p style="text-align:center; color:#667eea;">üîç Searching...</p>';
                
                try {
                    const res = await fetch('https://ideal-flow-production-2795.up.railway.app/api/match-grants', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            name: document.getElementById('name').value,
                            zip_code: document.getElementById('zip').value,
                            mission: document.getElementById('mission').value,
                            focus_area: document.getElementById('focus').value,
                            annual_budget: parseInt(document.getElementById('budget').value),
                            staff_size: document.getElementById('staff').value
                        })
                    });
                    
                    if (!res.ok) throw new Error('API error');
                    
                    const data = await res.json();
                    const grants = data.grants || [];
                    const matchedTitles = grants.map(g => g.title);
                    
                    let html = '<div class="results-container">';
                    html += '<div><h2 style="color:#667eea;">LA County Grant Map</h2>';
                    html += '<div class="legend">';
                    html += '<div class="legend-item"><span class="green-dot"></span><strong>Your Matches</strong></div>';
                    html += '<div class="legend-item"><span class="gray-dot"></span>Other Grants</div>';
                    html += '</div><div id="mapDiv"></div></div>';
                    
                    html += '<div class="grants-list"><h2 style="color:#667eea;">Found ' + grants.length + ' Grants</h2>';
                    grants.forEach(g => {
                        html += `<div class="grant"><h3>${g.title}</h3>
                            <p><strong>Funder:</strong> ${g.funder}</p>
                            <p><strong>Amount:</strong> ${g.amount}</p>
                            <p><span class="score">${g.match_score}% Match</span></p>
                            <p><em>${g.match_reason}</em></p>
                            <p style="font-size:14px; color:#666;">üìç ${g.eligibility}</p></div>`;
                    });
                    html += '</div></div>';
                    
                    out.innerHTML = html;
                    initializeMap('mapDiv', matchedTitles);
                    
                } catch(err) {
                    out.innerHTML = '<p style="color:red;">Error: ' + err.message + '</p>';
                }
            };
        });
    </script>
</body>
</html>
